<html xmlns:th="http://www.thymeleaf.org">
<head lang="en">
    <title>Homes available</title>
    <th:block th:include="fragments/headerincludes :: head"></th:block>
</head>
<body>
<th:block th:include="fragments/header :: header"></th:block>
<div class="container-fluid">
    <div class="row top-buffer bottom-buffer">
        <div th:if="${deleteSuccess}" class="col col-md-12 text-center">
            <div class="alert alert-success">
                <strong>Success!</strong> <span th:text="${deleteSuccess}"></span>
            </div>
        </div>
        <div th:if="${#lists.isEmpty(addresses)}" class="col col-md-12 text-center">
            <div class="alert alert-info">
                <strong>Info!</strong> No addresses found by that search parameter.
            </div>
            <a th:href="@{/}">
                <button class="btn btn-primary">Search again</button>
            </a>
        </div>
        <div th:if="${failedToDeleteError}" class="col col-md-12 text-center">
            <div class="alert alert-danger">
                <strong>Warning!</strong> <span th:text="${failedToDeleteError}"></span>
            </div>
        </div>
        <div th:if="${homeCreatedSuccess}" class="col col-md-12 text-center">
            <div class="alert alert-success">
                <strong>Success!</strong> <span th:text="${homeCreatedSuccess}"></span>
            </div>
        </div>
        <div th:if="${imageDeletedSuccessfully}" class="col col-md-12 text-center">
            <div class="alert alert-success">
                <strong>Success!</strong> <span th:text="${imageDeletedSuccessfully}"></span>
            </div>
        </div>
        <div th:if="${imageAddedSuccessfully}" class="col col-md-12 text-center">
            <div class="alert alert-success">
                <strong>Success!</strong> <span th:text="${imageAddedSuccessfully}"></span>
            </div>
        </div>
        <div th:if="${failedToEditError}" class="col col-md-12 text-center">
            <div class="alert alert-danger">
                <strong>Warning!</strong> <span th:text="${failedToEditError}"></span>
            </div>
        </div>
        <div th:if="${ratingAddedSuccess}" class="col col-md-12 text-center">
            <div class="alert alert-success">
                <strong>Success!</strong> <span th:text="${ratingAddedSuccess}"></span>
            </div>
        </div>
        <div th:if="${cannotRateHome}" class="col col-md-12 text-center">
            <div class="alert alert-danger">
                <strong>Warning!</strong> <span th:text="${cannotRateHome}"></span>
            </div>
        </div>

        <div class="col col-md-offset-2 col-md-8" th:each="address, var : ${addresses}">
            <div class="row" th:if="${var.index == 0}">
                <form th:action="@{/homes}" method="GET" class="form-group col-sm-2">
                    <select name="sortBy" class="input-sm" id="selectSort">
                        <option value="ratingDesc">Highest rated first</option>
                        <option value="ratingAsc">Lowest rated first</option>
                    </select>
                        <input type="submit" class="btn btn-primary" value="Sort by rating">
                </form>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="pull-left justify" th:inline="text">
                        [[${address.home.name}]] &nbsp;
                        <span th:if="${address.home.available}" class="label label-success pull-right">Available</span>
                        <span th:unless="${address.home.available}"
                              class="label label-danger pull-right">Not available</span>
                        <span th:inline="text" th:if="${address.home.averageRating}"
                              class="ratingLabel label label-info pull-right"><i class="glyphicon glyphicon-star"></i>[[${#numbers.formatDecimal(address.home.averageRating, 0, 'COMMA', 2, 'POINT')}]]</span>
                        <span th:inline="text" th:unless="${address.home.averageRating}"
                              class="ratingLabel label label-info pull-right"><i class="glyphicon glyphicon-star"></i>No ratings</span>

                    </h3>
                    <div class="btn-group pull-right">
                        <a th:href="@{/home/edit/{id}(id=${address.home.homeId})}">
                            <button th:if="${#strings.equals(address.home.user.userName, #authentication.getName()) || #strings.contains(#authentication.getAuthorities(), 'ROLE_ADMIN')}"
                                    class="btn btn-warning pull-left" type="button" id="editButton"
                            ><i class="glyphicon glyphicon-pencil"></i>&nbsp;Edit home
                            </button>
                        </a>
                        <button th:if="${#strings.equals(address.home.user.userName, #authentication.getName()) || #strings.contains(#authentication.getAuthorities(), 'ROLE_ADMIN')}"
                                th:attr="data-home-id=${address.home.homeId}" class="btn btn-danger"
                                data-toggle="modal" data-target="#deleteHomeModal" type="button"><i
                                class="glyphicon glyphicon-trash"></i>&nbsp;Delete
                            home
                        </button>
                        <button th:if="${(!@ratingService.existsByUsernameAndHomeId(#authentication.getName(), address.home.homeId) && !#strings.equals(address.home.user.userName, #authentication.getName()))}"
                                data-th-attr="
                                data-homename-id=${address.home.name},
                                            data-href-id=${'/home/' + address.home.homeId + '/rate'}"
                                class="btn btn-primary" id="rateHomeButton"
                                data-toggle="modal" data-target="#rateHomeModal" type="button"><i
                                class="glyphicon glyphicon-star"></i>&nbsp;Rate
                            home
                        </button>

                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col col-md-6">
                            <div class="row">
                                <h4 class="col-md-12">Address Information</h4>
                            </div>
                            <div class="row">
                                <span class="col-md-2 text-muted">Country:</span>
                                <span class="col-md-10" th:text="${address.country}"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-2 text-muted">Address:</div>
                                <div class="col-md-10"
                                     th:text="${address.street + ', ' + address.postalCode + ' ' + address.city}"></div>
                            </div>
                            <div class="row">
                                <hr class="col col-md-8"/>
                            </div>
                            <div class="row">
                                <h4 class="col-md-12">Home Information</h4>
                            </div>
                            <div class="row">
                                <div class="col-md-3 text-muted">Description:</div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 well well-md" id="descriptionWell"
                                     th:text="${address.home.description}"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 text-muted">Type:</div>
                                <div class="col-md-5" th:text="${address.home.type}"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 text-muted">Size In Square Meters:</div>
                                <div class="col-md-5" th:inline="text">[[${address.home.sizeInSquareMeters}]]
                                    m<sup>2</sup></div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 text-muted">Time Of Exchange:</div>
                                <div class="col-md-5"
                                     th:text="${address.home.timeOfExchangeInMonths + ' months'}"></div>
                            </div>
                            <div class="row">
                                <div class="col col-md-12">
                                    <button th:if="${(address.home.available || #strings.contains(#authentication.getAuthorities(), 'ROLE_ADMIN')) && !#strings.equals(address.home.user.userName, #authentication.getName())}"
                                            data-toggle="modal"
                                            data-target="#profileModal"
                                            data-th-attr="data-username-id=${address.home.user.userName},
                                            data-email-id=${address.home.user.email},
                                            data-phonenumber-id=${address.home.user.phoneNumber},
                                            data-fullname-id=${address.home.user.firstName +
                                    ' ' + address.home.user.lastName}"
                                            class="col col-md-12 text-center btn btn-primary contactOwnerButton top-buffer
                                    bottom-buffer">
                                        Contact Owner
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col col-md-6">
                            <div class="row">
                                <div class="col-lg-offset-1 col-lg-10 well">
                                    <div>
                                        <h3 class="pull-left bottom-buffer" th:inline="text"><i
                                                class="glyphicon glyphicon-camera"
                                                aria-hidden="true"></i>&nbsp;Photo
                                        </h3>
                                        <button th:if="${#strings.equals(address.home.user.userName, #authentication.getName()) || #strings.contains(#authentication.getAuthorities(), 'ROLE_ADMIN')}"
                                                class="btn btn-default pull-right" type="button"
                                                data-toggle="collapse"
                                                th:attr="data-target=${'#addImages' + var.count}"><i
                                                class="glyphicon glyphicon-plus"></i>
                                        </button>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-12 collapse bottom-buffer"
                                             th:id="${'addImages' + var.count}">
                                            <form th:action="@{/upload/images/} + ${address.home.homeId}"
                                                  enctype="multipart/form-data" method="post">
                                                <div class="form-group">
                                                    <input name="file" id="file" type="file"
                                                           class="filestyle"
                                                           data-buttonBefore="true"
                                                           data-buttonName="btn-primary"
                                                           th:attr="data-buttonText='&nbsp;' + 'Choose image...'"
                                                           required/><br/>
                                                </div>
                                                <button class="btn btn-primary"
                                                        type="submit">
                                                    Upload
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <div th:if="${address.home.image == null}" class="row">
                                        <div class="col-sm-12">
                                            <div class="col-sm-12">
                                                <p>No image added.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${address.home.image}" class="row">
                                        <div class="container col-lg-12 border-bottom bottom-buffer">
                                            <div>
                                                <img th:name="${address.home.image.name}"
                                                     class="homeImage"
                                                     style="max-width:100%"
                                                     th:src="@{'data:'+ ${address.home.image.contentType} + ';base64,' + ${address.home.image.generateBase64Image()}}"
                                                     title="Click to enlarge"/>
                                                <br/>
                                                <br/>
                                                <a th:if="${#strings.equals(address.home.user.userName, #authentication.getName()) || #strings.contains(#authentication.getAuthorities(), 'ROLE_ADMIN')}"
                                                   type="button"
                                                   class="btn btn-danger pull-left deleteImageButton"
                                                   th:attr="data-image-name=${address.home.image.name},link-template=@{/home/{homeId}/deleteImage/{imageId}(homeId=${address.home.homeId},imageId=${address.home.image.id})}">Delete</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-md-4">

</div>
</div>
</div>
<th:block th:include="fragments/footer :: footer"></th:block>
<!-- Modal -->
<div id="profileModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"><i class="glyphicon glyphicon-user"></i>&nbsp;Owner Profile</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <label>Full Name:</label>
                        <p id="modalUserFullName"></p>
                        <label>Username:</label>
                        <p id="modalUserName"></p>
                        <label>E-mail Address:</label>
                        <p id="modalUserEmail"></p>
                        <label>Phone Number:</label>
                        <p id="modalUserPhoneNumber"></p>
                    </div>
                    <div class="col-md-5">
                        <img src="https://i.guildwalls.com/users/avatars/22791.png?t=1229176239"/>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="emailButton">
                    <button id="emailBtn" type="button" class="btn btn-success pull-left"><i
                            class="glyphicon glyphicon-envelope"></i>&nbsp;E-mail
                    </button>
                </a>

                <button id="phoneButton" type="button" class="btn btn-success pull-left"><i
                        class="glyphicon glyphicon-phone"></i>&nbsp;Call
                </button>

                <a id="modalMessageButton">
                    <button type="button" class="btn btn-success pull-left"><i
                            class="glyphicon glyphicon-pencil"></i>&nbsp;Send a message
                    </button>
                </a>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<!-- Modal -->
<div id="deleteHomeModal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Delete Confirmation</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this home?</p>
            </div>
            <div class="modal-footer">
                <a id="deleteHomeButton">
                    <button type="button" class="btn btn-danger">Delete this home</button>
                </a>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
<!--Modal for viewing enlarged images-->
<div class="modal fade" id="enlargeImageModal" tabindex="-1" role="dialog" aria-labelledby="enlargeImageModal"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3 class="enlargeImageModalTitle">Image title</h3>
            </div>
            <div class="modal-body">
                <img src="" class="enlargeImageModalSource" style="width: 100%;"/>
            </div>
        </div>
    </div>
</div>
<!--END of Enlarged Images Modal-->
<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3 class="modal-title">Delete an image</h3>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <p class="text-center">
                        <span>You are about to delete </span> <strong id="image-name"></strong>.
                        <br/>
                        <span>Please confirm the operation.</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-lg"
                        data-dismiss="modal">Cancel
                </button>
                <a type="button" class="btn btn-danger btn-lg" id="deleteImage"
                   href="#">Delete</a>
            </div>
        </div>
    </div>
</div>
<!-- Rate home modal -->
<div class="modal fade" id="rateHomeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3 class="modal-title">Rate <span id="homeName"></span></h3>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    Select rating (1 to 5):
                    <br/>
                    <form id="rateHomeForm" class="rating form-group" method="POST">
                        <label>
                            <input type="radio" name="ratingValue" value="1" required/>
                            <span class="icon">★</span>
                        </label>
                        <label>
                            <input type="radio" name="ratingValue" value="2" required/>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                        </label>
                        <label>
                            <input type="radio" name="ratingValue" value="3" required/>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                        </label>
                        <label>
                            <input type="radio" name="ratingValue" value="4" required/>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                        </label>
                        <label>
                            <input type="radio" name="ratingValue" value="5" required/>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                            <span class="icon">★</span>
                        </label>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-lg"
                        data-dismiss="modal">Cancel
                </button>
                <input type="submit" class="btn btn-lg btn-success" form="rateHomeForm" value="Rate"/>
            </div>
        </div>
    </div>
</div>
</body>
</html>